<window title="SecondMarket Grid Test" border="normal" width="100%">
<zscript language="Java">
 <![CDATA[
   import java.sql.Connection;
   import java.sql.Statement;
   import java.sql.DriverManager;
   import java.sql.ResultSet; 
   import java.sql.SQLException;
   import java.sql.ResultSetMetaData;
   import java.text.DecimalFormat;
   import java.text.SimpleDateFormat;
   import java.util.ArrayList;

   Class.forName("oracle.jdbc.OracleDriver");
   Connection conn = DriverManager.getConnection("jdbc:oracle:thin:@//localhost","morningstar","uptime5");
   Statement stmt = conn.createStatement();
   
   DecimalFormat iFmt = new DecimalFormat("#,###");
   DecimalFormat pctFmt = new DecimalFormat("#,###.00%");
   SimpleDateFormat dateFmt = new SimpleDateFormat("MMM-yy");

   public void doClick() {
    query = sqlTextBox.getValue().trim();
    ResultSet rs = null;
    try {
      rs = stmt.executeQuery( query );
    } catch ( SQLException sqle ) {
      alert( "INVALID SQL QUERY: Please check your sql and try again.\n\nError Message:" + sqle.getMessage() );
      return;
    }

    ResultSetMetaData metaData = rs.getMetaData();
    int columnCount = metaData.getColumnCount();
    
    while ( gridColumns.getFirstChild() != null ) {
      gridColumns.removeChild( gridColumns.getFirstChild() );
    }

    ArrayList colNames = new ArrayList();

    for ( int i=1; i<=columnCount; i++ ) {
      String columnName = metaData.getColumnName(i);
      colNames.add( columnName );
      if ( columnName.equals("COMPANY_NAME") ) {
        Label colLabel = new Label( "Company Name" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort( "auto" );
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("CITY") ) {
        Label colLabel = new Label( "City" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort( "auto" );
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("STATE") ) {
        Label colLabel = new Label( "State" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort( "auto" );
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("SECOND_MARKET_URL") ) {
        Label colLabel = new Label( "Second Market URL" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("COMPANY_URL") ) {
        Label colLabel = new Label( "Company URL" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("LAST_FUNDING_DATE") ) {
        Label colLabel = new Label( "Last Funding Date" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort("auto");
        col.setAlign("right");
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("LAST_FUNDING_AMOUNT") ) {
        Label colLabel = new Label( "Last Funding Amount" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort("auto");
        col.setAlign("right");
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("UNIQUE_VISITORS") ) {
        Label colLabel = new Label( "Unique Web Visitors" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort("auto");
        col.setAlign("right");
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
      else if ( columnName.equals("VISITOR_GROWTH") ) {
        Label colLabel = new Label( "Web Visitor Growth" );
        colLabel.setStyle("font-weight:bold;");
        Column col = new Column();
        col.setSort("auto");
        col.setAlign("right");
        col.appendChild( colLabel );
        gridColumns.appendChild( col );
      }
    }

    while ( tableRows.getFirstChild() != null ) {
      tableRows.removeChild( tableRows.getFirstChild() );
    }

    while ( rs.next() ) {
     Row myRow = new Row();
     for ( String colName : colNames ) {
       if ( colName.equals("COMPANY_NAME") ) {
         Label lbl = new Label( rs.getString( colName ) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       } 
       else if ( colName.equals("CITY") ) {
         Label lbl = new Label( rs.getString( colName ) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       }
       else if ( colName.equals("STATE") ) {
         Label lbl = new Label( rs.getString( colName ) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       }
       else if ( colName.equals("SECOND_MARKET_URL") ) {
         A a = new A( rs.getString( colName ) );
         a.setStyle("font-weight:bold;");
         a.setHref( rs.getString( colName ) );
         a.setTarget( "_blank" );
         myRow.appendChild( a );
       }
       else if ( colName.equals("COMPANY_URL") ) {
         A a = new A( rs.getString( colName ) );
         a.setStyle("font-weight:bold;");
         a.setHref( rs.getString( colName ) );
         a.setTarget( "_blank" );
         myRow.appendChild( a );
       }
       else if ( colName.equals("LAST_FUNDING_DATE") ) {
         Label lbl = new Label( dateFmt.format(rs.getDate( colName )) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       }
       else if ( colName.equals("LAST_FUNDING_AMOUNT") ) {
         Label lbl = new Label( iFmt.format(rs.getInt( colName )) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       }
       else if ( colName.equals("UNIQUE_VISITORS") ) {
         Label lbl = new Label( iFmt.format(rs.getInt( colName )) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       } 
       else if ( colName.equals("VISITOR_GROWTH") ) {
         Label lbl = new Label( pctFmt.format(rs.getInt( colName )) );
         lbl.setStyle("font-weight:bold;");
         myRow.appendChild( lbl );
       }
     }
     tableRows.appendChild( myRow );
    }

    /*
    while ( rs.next() ) {
      Row myRow = new Row();
      ArrayList lblList = new ArrayList();
      lblList.add( new Label( rs.getString(1) ) );
      lblList.add( new Label( rs.getString(2) ) );
      lblList.add( new Label( rs.getString(3) ) );

      for ( Label myLbl : lblList ) {
        myLbl.setStyle("font-weight:bold;");
        myRow.appendChild( myLbl );
      }

      A secondA = new A( rs.getString(4) );
      secondA.setHref( rs.getString(4) );
      secondA.setStyle("font-weight:bold;");
      secondA.setTarget("_blank");
      myRow.appendChild( secondA );
      A companyA = new A( rs.getString(5) );
      companyA.setHref( rs.getString(5) );
      companyA.setStyle("font-weight:bold;");
      companyA.setTarget("_blank");
      myRow.appendChild( companyA );
      myRow.appendChild( new Label( dateFmt.format( rs.getDate(6) ) ) );
      myRow.appendChild( new Label( iFmt.format( rs.getInt(7) ) ) );
      myRow.appendChild( new Label( iFmt.format( rs.getInt(10) ) ) );
      myRow.appendChild( new Label( pctFmt.format( rs.getDouble(11) ) ) );

      tableRows.appendChild( myRow );
    } */

    rs.close();
   }
 ]]>
</zscript>
<vbox width="100%" heights="150px,*">
<tabbox id="myTabBox">
 <tabs id="myTabs">
   <tab id="guiTab" label="Query Builder"/>
   <tab id="sqlTab" label="SQL"/>
 </tabs> 
 <tabpanels>
  <tabpanel id="guiPanel">
   <label value="GUI panel goes here."/>
  </tabpanel>
  <tabpanel id="sqlPanel">
   <hlayout>
    <listbox id="columnListBox" width="400px">
     <listhead>
       <listheader label="Column"/>
       <listheader label="Description"/>
     </listhead>
     <listitem>
       <listcell label="COMPANY_NAME"/>
       <listcell label="Name of Company"/>
     </listitem>
     <listitem>
       <listcell label="CITY"/>
       <listcell label="City of company's headquarters."/>
     </listitem>
     <listitem>
       <listcell label="STATE"/>
       <listcell label="State where company's headquarters is located."/>
     </listitem>
     <listitem>
       <listcell label="SECOND_MARKET_URL"/>
       <listcell label="URL of company's SecondMarket profile if available."/>
     </listitem>
     <listitem>
       <listcell label="COMPANY_URL"/>
       <listcell label="URL of company's homepage."/>
     </listitem>
     <listitem>
       <listcell label="LAST_FUNDING_DATE"/>
       <listcell label="Month &amp; Year of company's last VC fundraiser."/>
     </listitem>
     <listitem>
       <listcell label="LAST_FUNDING_AMOUNT"/>
       <listcell label="Dollar amount raised company's last funding."/>
     </listitem>
     <listitem>
       <listcell label="UNIQUE_VISITORS"/>
       <listcell label="Last count of monthly unique website visitors."/>
     </listitem>
     <listitem>
       <listcell label="VISITOR_GROWTH"/>
       <listcell label="Annual Web traffic growth as measured by unique visitor count."/>
     </listitem>
    </listbox>
    <vlayout>
     <textbox id="sqlTextBox" rows="6" width="700px">
     </textbox>
     <div align="center">
      <button style="font-weight:bold;" label="Run Query" width="100px" height="30px" onClick="doClick();">
      </button>
     </div>
    </vlayout>
   </hlayout>
  </tabpanel>
 </tabpanels>
</tabbox>
<splitter id="s1" collapse="before"/>
<div style="font-weight:bold;">
<grid> 
 <auxhead>
  <auxheader colspan="1" label="SecondMarket Fundraising Data"/>
 </auxhead>
 <columns id="gridColumns" sizable="true">
    <column sort="auto"><label value="Company Name" style="font-weight:bold;"/></column>
    <column sort="auto"><label value="City" style="font-weight:bold;"/></column>
    <column sort="auto"><label value="State" style="font-weight:bold;"/></column>
    <column><label value="Second Market URL" style="font-weight:bold;"/></column>
    <column><label value="Company URL" style="font-weight:bold;"/></column>
    <column align="right" sort="auto"><label value="Last Funding Date" style="font-weight:bold;"/></column>
    <column sort="auto" align="right"><label value="Last Funding Amount" style="font-weight:bold;"/></column>
    <column align="right" sort="auto"><label value="Unique Web Visitors" style="font-weight:bold;"/></column>
    <column align="right" sort="auto"><label value="1-Yr Web Visitor Growth" style="font-weight:bold;"/></column>
  </columns>
  <rows id="tableRows"></rows>
</grid>
</div>
</vbox>
<zscript language="Groovy">
 <![CDATA[
  import groovy.sql.Sql
  import java.text.DecimalFormat
  import java.text.SimpleDateFormat

  def sql = Sql.newInstance("jdbc:oracle:thin:morningstar/uptime5@localhost:1521:XE","morningstar","uptime5","oracle.jdbc.OracleDriver")
  
  def dateFormatter = new SimpleDateFormat("MMM-yy")
  def integerFormatter = new DecimalFormat("#,###")
  def pctFormatter = new DecimalFormat("#,###.00%")

  def queryString = "SELECT * FROM (SELECT * FROM second_market_fact_table WHERE ( state='CA' ) ORDER BY last_funding_date DESC, last_funding_amount DESC) WHERE rownum<251"

  sql.eachRow( queryString ) {
    def myRow = new Row()
    def lblList = []
    lblList.add( new Label( it.company_name ) )
    lblList.add( new Label( it.city ) )
    lblList.add( new Label( it.state ) )
    def secondMarketA = new A(it.second_market_url)
    secondMarketA.setHref(it.second_market_url)
    secondMarketA.setTarget("_blank")
    lblList.add( secondMarketA )
    def companyA = new A(it.company_url)
    companyA.setHref(it.company_url)
    companyA.setTarget("_blank")
    lblList.add( companyA )
    lblList.add( new Label( dateFormatter.format(it.last_funding_date) ) )
    lblList.add( new Label( integerFormatter.format(it.last_funding_amount) ) )
    if ( it.unique_visitors != null ) {
      lblList.add( new Label( integerFormatter.format(it.unique_visitors) ) )
    } else { lblList.add( new Label() ) }
    if ( it.visitor_growth != null ) {
      lblList.add( new Label( pctFormatter.format(it.visitor_growth) ) )
    }  else { lblList.add( new Label() ) }

    lblList.each { lbl ->
      lbl.setStyle("font-weight:bold;")
      myRow.appendChild( lbl )
    }

    tableRows.appendChild( myRow )
  }

  sqlTextBox.setValue( queryString );
 ]]>
</zscript>
</window>
